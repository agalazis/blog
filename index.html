<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="Software,Development,Engineering,Blog" />
       
      <meta name="description" content="Software Development &amp; Engineering Blog" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> A point in Time</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/blog/favicon.ico" />
       
<link rel="stylesheet" href="/blog/dist/main.css">

      
<link rel="stylesheet" href="/blog/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/blog/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
    <style>aside.sidebar{width: 10rem;}aside.sidebar{left: -10rem;}aside.sidebar .navbar-toggle{left: 11.5rem;}</style><!-- hexo injector head_end end --><link rel="alternate" href="/blog/atom.xml" title="A point in Time" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/assets/img/waves.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/blog/">A point in Time</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['“Time is an illusion.” ― Albert Einstein', '', ''],
        startDelay: 1000,
        typeSpeed: 75,
        loop: false,
        backSpeed: 99999,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="post-Dynamic-execution-of-Fargate-tasks-triggered-via-AWS-Event-Bridge"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/blog/2022/08/13/Dynamic-execution-of-Fargate-tasks-triggered-via-AWS-Event-Bridge/"
    >Dynamic execution of Fargate tasks triggered via AWS Event Bridge</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/blog/2022/08/13/Dynamic-execution-of-Fargate-tasks-triggered-via-AWS-Event-Bridge/" class="article-date">
  <time datetime="2022-08-13T20:03:01.000Z" itemprop="datePublished">2022-08-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/DevOps/">DevOps</a> / <a class="article-category-link" href="/blog/categories/DevOps/cloud/">cloud</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="AWS-Event-Bridge-ans-AWS-Fargate-A-match-made-in-heaven"><a href="#AWS-Event-Bridge-ans-AWS-Fargate-A-match-made-in-heaven" class="headerlink" title="AWS Event Bridge ans AWS Fargate: A match made in heaven"></a>AWS Event Bridge ans AWS Fargate: A match made in heaven</h2><p>Running a command in container on demand is a powerful feature of AWS Fargate. This opens a whole world of possibilities when combined with aws even bridge. Using en <code>EventRule</code> you can match existing aws events or custom events you intend to send to event bridge and set an AWS Fargate task as a target.</p>
<h2 id="A-practical-Example"><a href="#A-practical-Example" class="headerlink" title="A practical Example"></a>A practical Example</h2><p>To see this in practice well see an example in aws CDK:</p>
<p>First we create a base class for our triggered constructs that is responsible for:</p>
<ul>
<li>Creating the event target fargate task given <code>taskDefinition</code>, <code>securityGroups</code> and <code>containerOverrides</code> . Task definition will let you set memory &amp; cpu to be used the image, the command to be run and logging. Security Groups define access . Container overrides give you the option to override the configuration and the environment of container, we ‘ll come back to this hidden gem later. Once the ecs task is created it’s assigned as a target to the provided rule.</li>
<li>Configuring aws log driver. That’s useful for viewing execution output in AWS cloudwath.</li>
<li>Discovering/ maintaining a default ecs cluster of the vpc(for the task to be run in) if we don’t provide a specific cluster to use</li>
</ul>
<p>Then we create a subclass that simplifies construct creation responsible for constructing task definitions.<br>We could also have a scheduled task sublclass that could created the cron like event rule internally.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">TriggeredTaskBase</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Construct</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">cluster</span>: <span class="title class_">ICluster</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">desiredTaskCount</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">eventRule</span>: <span class="title class_">Rule</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scope: Construct, id: <span class="built_in">string</span>, props: TriggeredTaskBaseProps</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(scope, id);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cluster</span> = props.<span class="property">cluster</span> || <span class="variable language_">this</span>.<span class="title function_">getDefaultCluster</span>(<span class="variable language_">this</span>, props.<span class="property">vpc</span>);</span><br><span class="line">    <span class="keyword">if</span> (props.<span class="property">desiredTaskCount</span> !== <span class="literal">undefined</span> &amp;&amp; props.<span class="property">desiredTaskCount</span> &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;You must specify a desiredTaskCount greater than 0&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">desiredTaskCount</span> = props.<span class="property">desiredTaskCount</span> || <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An EventRule that describes the event trigger</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eventRule</span> = props.<span class="property">rule</span>;</span><br><span class="line">    <span class="title class_">Tags</span>.<span class="title function_">of</span>(<span class="variable language_">this</span>).<span class="title function_">add</span>(<span class="string">&#x27;Module&#x27;</span>, <span class="title function_">getModuleName</span>(__filename));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create an ECS task using the task definition provided and as a target to the event rule.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> taskDefinition the TaskDefinition to add to the event rule</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">addTaskDefinitionToEventTarget</span>(&#123;</span><br><span class="line">    taskDefinition,</span><br><span class="line">    securityGroups,</span><br><span class="line">    containerOverrides,</span><br><span class="line">  &#125;: &#123;</span><br><span class="line">    <span class="attr">taskDefinition</span>: <span class="title class_">TaskDefinition</span>;</span><br><span class="line">    securityGroups?: <span class="title class_">ISecurityGroup</span>[];</span><br><span class="line">    containerOverrides?: <span class="title class_">ContainerOverride</span>[];</span><br><span class="line">  &#125;): <span class="title class_">EcsTask</span> &#123;</span><br><span class="line">    <span class="comment">// Use the EcsTask as the target of the EventRule</span></span><br><span class="line">    <span class="keyword">const</span> eventRuleTarget = <span class="keyword">new</span> <span class="title class_">EcsTask</span>(&#123;</span><br><span class="line">      <span class="attr">cluster</span>: <span class="variable language_">this</span>.<span class="property">cluster</span>,</span><br><span class="line">      taskDefinition,</span><br><span class="line">      <span class="attr">taskCount</span>: <span class="variable language_">this</span>.<span class="property">desiredTaskCount</span>,</span><br><span class="line">      containerOverrides,</span><br><span class="line">      securityGroups,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eventRule</span>.<span class="title function_">addTarget</span>(eventRuleTarget);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> eventRuleTarget;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the default cluster.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">getDefaultCluster</span>(<span class="attr">scope</span>: <span class="title class_">Construct</span>, vpc?: <span class="title class_">IVpc</span>): <span class="title class_">Cluster</span> &#123;</span><br><span class="line">    <span class="comment">// magic string to avoid collision with user-defined constructs</span></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">DEFAULT_CLUSTER_ID</span> = <span class="string">`EcsDefaultCluster<span class="subst">$&#123;vpc ? vpc.node.id : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> stack = <span class="title class_">Stack</span>.<span class="title function_">of</span>(scope);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      (stack.<span class="property">node</span>.<span class="title function_">tryFindChild</span>(<span class="variable constant_">DEFAULT_CLUSTER_ID</span>) <span class="keyword">as</span> <span class="title class_">Cluster</span>) ||</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cluster</span>(stack, <span class="variable constant_">DEFAULT_CLUSTER_ID</span>, &#123; vpc &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">createAWSLogDriver</span>(<span class="attr">prefix</span>: <span class="built_in">string</span>): <span class="title class_">AwsLogDriver</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AwsLogDriver</span>(&#123; <span class="attr">streamPrefix</span>: prefix &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TriggeredFargateTask</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TriggeredTaskBase</span> &#123;</span><br><span class="line">  <span class="comment">// Create a Task Definition for the container to start</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">taskDefinition</span>: <span class="title class_">TaskDefinition</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">eventTarget</span>: <span class="title class_">EcsTask</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scope: Construct, id: <span class="built_in">string</span>, props: TriggeredFargateTaskProps</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(scope, id, props);</span><br><span class="line">    <span class="keyword">if</span> (props.<span class="property">triggeredFargateTaskDefinitionOptions</span> &amp;&amp; props.<span class="property">triggeredFargateTaskImageOptions</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You must specify either a triggeredFargateTaskDefinitionOptions or triggeredFargateTaskOptions, not both.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (props.<span class="property">triggeredFargateTaskDefinitionOptions</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">taskDefinition</span> = props.<span class="property">triggeredFargateTaskDefinitionOptions</span>.<span class="property">taskDefinition</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (props.<span class="property">triggeredFargateTaskImageOptions</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> taskImageOptions = props.<span class="property">triggeredFargateTaskImageOptions</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">taskDefinition</span> = <span class="keyword">new</span> <span class="title class_">FargateTaskDefinition</span>(<span class="variable language_">this</span>, <span class="string">&#x27;TriggeredTaskDef&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">taskRole</span>: props.<span class="property">taskRole</span>,</span><br><span class="line">        <span class="attr">memoryLimitMiB</span>: taskImageOptions.<span class="property">memoryLimitMiB</span> || <span class="number">512</span>,</span><br><span class="line">        <span class="attr">cpu</span>: taskImageOptions.<span class="property">cpu</span> || <span class="number">256</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">const</span> &#123; logDriver, ...imageOptions &#125; = taskImageOptions;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">taskDefinition</span>.<span class="title function_">addContainer</span>(props.<span class="property">containerName</span>, &#123;</span><br><span class="line">        ...imageOptions,</span><br><span class="line">        <span class="attr">logging</span>: logDriver !== <span class="literal">undefined</span> ? logDriver : <span class="variable language_">this</span>.<span class="title function_">createAWSLogDriver</span>(<span class="variable language_">this</span>.<span class="property">node</span>.<span class="property">id</span>),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;You must specify one of: taskDefinition or image&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eventTarget</span> = <span class="variable language_">this</span>.<span class="title function_">addTaskDefinitionToEventTarget</span>(&#123;</span><br><span class="line">      <span class="attr">taskDefinition</span>: <span class="variable language_">this</span>.<span class="property">taskDefinition</span>,</span><br><span class="line">      <span class="attr">securityGroups</span>: props.<span class="property">securityGroups</span>,</span><br><span class="line">      <span class="attr">containerOverrides</span>: props.<span class="property">containerOverrides</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> Until now it all seems straight forward. We can now create our task. In our example we run a database migration task:<br> <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">TriggeredFargateTask</span>(<span class="variable language_">this</span>, <span class="string">`my-proj ManagementTask`</span>, &#123;</span><br><span class="line">     cluster,</span><br><span class="line">     <span class="attr">taskRole</span>: imageOptions.<span class="property">taskRole</span>,</span><br><span class="line">     containerName,</span><br><span class="line">     securityGroups,</span><br><span class="line">     <span class="attr">triggeredFargateTaskImageOptions</span>: &#123;</span><br><span class="line">       ...imageOptions,</span><br><span class="line">       <span class="attr">cpu</span>: <span class="number">2048</span>,</span><br><span class="line">       <span class="attr">memoryLimitMiB</span>: <span class="number">4096</span>,</span><br><span class="line">       <span class="attr">command</span>: [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;python manage.py migrate&#x27;</span>],</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">rule</span>: <span class="keyword">new</span> <span class="title class_">Rule</span>(<span class="variable language_">this</span>, <span class="string">`my-proj Management Trigger`</span>, &#123;</span><br><span class="line">       <span class="attr">eventPattern</span>: &#123;</span><br><span class="line">         <span class="attr">detail</span>: &#123;</span><br><span class="line">           <span class="attr">subject</span>: [<span class="string">&#x27;execute&#x27;</span>],</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">detailType</span>: [<span class="string">&#x27;Management&#x27;</span>],</span><br><span class="line">         <span class="attr">source</span>: [<span class="string">`com.corp.env.my-proj.manage`</span>],</span><br><span class="line">       &#125;,</span><br><span class="line">     &#125;),</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure><br>Now if you wanted to run another command using the same image run another task you would create another task and so on and so forth.</p>
<h2 id="The-one-task-to-rule-them-all"><a href="#The-one-task-to-rule-them-all" class="headerlink" title="The one task to rule them all"></a>The one task to rule them all</h2><p>If you are familiar with <code>django</code>(the above example demonstrates executing django management commands) you will know that there is a plethora of commands that you would want to run and creating a task for each command would require considerable amount of effort. The other issue is that some commands accept parameters which would be impractical to be hardcoded in task definition. Facing this issues I embarked on a journey to create the one task to rule them all. </p>
<h2 id="Container-Overrides-to-the-rescue"><a href="#Container-Overrides-to-the-rescue" class="headerlink" title="Container Overrides to the rescue"></a>Container Overrides to the rescue</h2><p>The concept was simple. I wanted to provide parameters  to the fargate task  dynamically when triggering the event bridge event. Although it seemed a common use case, most of the <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/62807320/how-to-get-the-event-content-in-ecs-when-it-is-invoked-by-cloudwatch-eventbridge">solutions</a> I found where suggesting setting up an sqs queue that would accept messages containing the parameters consumed at execution time, which seemed like an overkill to me. The only way I have found to pass data to the container without involving extra resources was to set environment variables from event bridge event payload via container overrides(using input transformer behavior). I actually found this by digging in some <a target="_blank" rel="noopener" href="https://github.com/aws-samples/aws-cdk-examples/issues/254">github tickets</a> rather than finding some reference solution, neither the docs where clear on how to use the constructs to reach to a solution. Here is our revised example:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">TriggeredFargateTask</span>(<span class="variable language_">this</span>, <span class="string">`my-proj ManagementTask`</span>, &#123;</span><br><span class="line">     cluster,</span><br><span class="line">     <span class="attr">taskRole</span>: imageOptions.<span class="property">taskRole</span>,</span><br><span class="line">     containerName,</span><br><span class="line">     securityGroups,</span><br><span class="line">     <span class="attr">triggeredFargateTaskImageOptions</span>: &#123;</span><br><span class="line">       ...imageOptions,</span><br><span class="line">       <span class="attr">cpu</span>: <span class="number">2048</span>,</span><br><span class="line">       <span class="attr">memoryLimitMiB</span>: <span class="number">4096</span>,</span><br><span class="line">       <span class="attr">command</span>: [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;python manage.py $MANAGEMENT_COMMAND&#x27;</span>],</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">rule</span>: <span class="keyword">new</span> <span class="title class_">Rule</span>(<span class="variable language_">this</span>, <span class="string">`my-proj Management Trigger`</span>, &#123;</span><br><span class="line">       <span class="attr">eventPattern</span>: &#123;</span><br><span class="line">         <span class="attr">detail</span>: &#123;</span><br><span class="line">           <span class="attr">subject</span>: [<span class="string">&#x27;execute&#x27;</span>],</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">detailType</span>: [<span class="string">&#x27;Management&#x27;</span>],</span><br><span class="line">         <span class="attr">source</span>: [<span class="string">`com.corp.env.my-proj.manage`</span>],</span><br><span class="line">       &#125;,</span><br><span class="line">     &#125;),</span><br><span class="line">     <span class="attr">containerOverrides</span>: [</span><br><span class="line">       &#123;</span><br><span class="line">         containerName,</span><br><span class="line">         <span class="attr">environment</span>: [</span><br><span class="line">           &#123;</span><br><span class="line">             <span class="attr">name</span>: <span class="string">&#x27;MANAGEMENT_COMMAND&#x27;</span>,</span><br><span class="line">             <span class="attr">value</span>: <span class="title class_">EventField</span>.<span class="title function_">fromPath</span>(<span class="string">&#x27;$.detail.command&#x27;</span>),</span><br><span class="line">           &#125;,</span><br><span class="line">         ],</span><br><span class="line">       &#125;,</span><br><span class="line">     ],</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>

<p>Notice that the command  changed to :</p>
<p><code>command: [&#39;sh&#39;, &#39;-c&#39;, &#39;python manage.py $MANAGEMENT_COMMAND&#39;],</code></p>
<p>and we added the following override:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containerOverrides</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    containerName,</span><br><span class="line">    <span class="attr">environment</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;MANAGEMENT_COMMAND&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="title class_">EventField</span>.<span class="title function_">fromPath</span>(<span class="string">&#x27;$.detail.command&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>The above override uses <code>EventField.fromPath(&#39;$.detail.command&#39;)</code>  to transform the value of <code>detail.command</code> from the event to the  value of the environment variable in the container override. Now  <code>detail.command</code> attribute of our event can hold any arbitrary command including any parameters we want (the migration to migrate to for example). This allows us to dynamically specify what we expect to run in the container.<br>A sample sample of triggering the above using event bridge event via cdk would be the following:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> eventDetails = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title class_">Detail</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">subject</span>: <span class="string">&#x27;execute&#x27;</span>, <span class="attr">command</span>:<span class="string">&#x27;showmigrations myapp&#x27;</span>&#125;),</span><br><span class="line">    <span class="title class_">DetailType</span>: <span class="string">&#x27;Management&#x27;</span>,</span><br><span class="line">    <span class="title class_">Resources</span>: [],</span><br><span class="line">    <span class="title class_">Source</span>: <span class="string">`com.corp.env.my-proj.manage`</span>,</span><br><span class="line">    <span class="title class_">Time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line">eventBridge</span><br><span class="line">  .<span class="title function_">putEvents</span>(eventDetails)</span><br><span class="line">  .<span class="title function_">promise</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Successfully triggered django management event details:\n&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data, <span class="literal">null</span>, <span class="number">4</span>))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>The above would trigger showing migrations of myapp. To see the output you can check cloudwatch . You would normally accept the command as command line argument or as an argument of a function/method depending on if you are creating a CLI tool or a Library. (typically you would do a library that is used by your cli tool as well)</p>
<p>The above demonstrates how you can be flexible when emitting orchestration commands as events but could also be used in a choreographic scenario(system event for example) where the consuming target gets some configuration about execution from an event passed as environment variable. </p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/aws/" rel="tag">aws</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/aws-cdk/" rel="tag">aws-cdk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ecs/" rel="tag">ecs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/event-bridge/" rel="tag">event-bridge</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/fargate/" rel="tag">fargate</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Waydroid-setup-on-fedora"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/blog/2022/08/02/Waydroid-setup-on-fedora/"
    >Waydroid setup on fedora (with google services)</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/blog/2022/08/02/Waydroid-setup-on-fedora/" class="article-date">
  <time datetime="2022-08-02T06:06:23.000Z" itemprop="datePublished">2022-08-02</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/linux/">linux</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>Want to use an android app on your computer? <a target="_blank" rel="noopener" href="https://waydro.id/">Waydroid</a>  has you covered I have also had a look in <a target="_blank" rel="noopener" href="https://anbox.io/">anbox</a> in the past but it seemed to be a lot of trouble to setup and sort of unstable to use(at leas on machine). Installing wydroid is straight forward while using it seems flowless to me. I have managed to get it working on my <a target="_blank" rel="noopener" href="https://www.notebookcheck.net/Lenovo-ThinkPad-X260-Core-i7-FHD-Subnotebook-Review.166601.0.html">thinkpad x260</a> I would like to get it working on my thinkpad t14 gen3 as well but that’s nothing to blame <a target="_blank" rel="noopener" href="https://waydro.id/">waydroid</a> for since my t14 has general display issues.</p>
<h3 id="Installation-Steps"><a href="#Installation-Steps" class="headerlink" title="Installation Steps"></a>Installation Steps</h3><p>Here are the steps I followed to set it up :</p>
<ol>
<li><p>Make sure you’re using kernel version 5.15 or higher</p>
</li>
<li><p>Add the Copr repository:<br> <code>sudo dnf copr enable aleasto/waydroid</code></p>
</li>
<li><p>Update sepolicy  if using fedora35 (I didn’t need to run this step)<br> <code>sudo dnf update</code></p>
</li>
<li><p>Install waydroid<br> <code>sudo dnf install waydroid</code></p>
</li>
<li><p>Initialize waydroid. To include google services flag don’t forget the <code>gapps</code> flag wen initializing waydroid:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo waydroid init -c https://ota.waydro.id/system -v https://ota.waydro.id/vendor -s GAPPS</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Google-services-registration"><a href="#Google-services-registration" class="headerlink" title="Google services registration"></a>Google services registration</h3><ol>
<li>Register the output of the following  command at<br><a target="_blank" rel="noopener" href="https://www.google.com/android/uncertified/">https://www.google.com/android/uncertified/</a> :<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;ANDROID_RUNTIME_ROOT=/apex/com.android.runtime sqlite3 /data/data/com.google.android.gsf/databases/gservices.db &quot;select * from main where name = \&quot;android_id\&quot;;&quot;&#x27;| sudo waydroid shell</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li>To mitigate changing registration number add a cron job:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su </span><br><span class="line">crontab -e</span><br></pre></td></tr></table></figure>
add the following line:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/5 * * * *       echo &#x27;ANDROID_RUNTIME_ROOT=/apex/com.android.runtime sqlite3 /data/data/com.google.android.gsf/databases/gservices.db &quot;update main set value=\&quot;&lt;DEVICE_ID&gt;\&quot; where name = \&quot;android_id\&quot;;&quot;&#x27;| /usr/bin/waydroid shell</span><br></pre></td></tr></table></figure>
replace <code>&lt;DEVICE_ID&gt;</code> with the device id you have registered in previous step.</li>
</ol>
<h3 id="Use"><a href="#Use" class="headerlink" title="Use"></a>Use</h3><p>You may now start waydroid using the desktop menu entry. It will take some time for your device to register so if you receive any google service errors reporting your device as unregistered try again later.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/android/" rel="tag">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/fedora/" rel="tag">fedora</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/waydroid/" rel="tag">waydroid</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Applying-firmware-upgrades-on-linux-with-fwupd"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/blog/2022/07/22/Applying-firmware-upgrades-on-linux-with-fwupd/"
    >Applying firmware upgrades on linux with fwupd</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/blog/2022/07/22/Applying-firmware-upgrades-on-linux-with-fwupd/" class="article-date">
  <time datetime="2022-07-22T19:22:25.000Z" itemprop="datePublished">2022-07-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/linux/">linux</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>Sometimes you might need to perform a firmware upgrade of some hardware on your machine (Intel Management Engine, your finger print reader, your ssd disk etc).<br>This can be performed via <code>fwupdmgr</code> <code>fwupd</code> command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fwupdmgr get-devices # Get all devices that support firmware updates</span><br><span class="line">fwupdmgr refresh # Refresh metadata from remote server use --force if you want to refresh again without 3 hours passing</span><br><span class="line">fwupdmgr get-updates # Gets the list of updates for connected hardware</span><br><span class="line">fwupdmgr update # Updates all specified devices to latest firmware version, or all devices if unspecified</span><br></pre></td></tr></table></figure>

<p>Keeping the snippet here for future reference hope it helps somebody.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/firmware/" rel="tag">firmware</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/fwupd/" rel="tag">fwupd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Python-map-built-in-function-why-it-s-superior-to-javascript-array-map-method-and-how-to-implement-it"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/blog/2021/09/24/Python-map-built-in-function-why-it-s-superior-to-javascript-array-map-method-and-how-to-implement-it/"
    >Python map built-in function, why  it&#39;s superior to javascript array map method and how to implement it</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/blog/2021/09/24/Python-map-built-in-function-why-it-s-superior-to-javascript-array-map-method-and-how-to-implement-it/" class="article-date">
  <time datetime="2021-09-24T18:50:17.000Z" itemprop="datePublished">2021-09-24</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Software-Engineering/">Software Engineering</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>According to python docs <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html#map">map</a> build in function applies a given function to every item of an iterable, <strong>yielding</strong> the results. <code>map</code> returns an object that is an iterable lazily executing the provided transformation function to each element of input iterable. From the above we understand that map works pretty much like an Generator.</p>
<h2 id="Why-is-this-awesome"><a href="#Why-is-this-awesome" class="headerlink" title="Why is this awesome ?"></a>Why is this awesome ?</h2><p>Well If you were to perform an expensive transformation on a huge iterable just to utilize a sub-part of it, lazily transforming what’s needed is the optimal approach. Let’s have a look at the following example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def isEven(val):</span><br><span class="line">    print(F&#x27;processing &#123;val&#125;&#x27; )</span><br><span class="line">    return (val % 2) == 0</span><br><span class="line"></span><br><span class="line">huge_range = range(1,10**24+1)</span><br><span class="line"></span><br><span class="line">if any(map(isEven, huge_range)):</span><br><span class="line">  print(&#x27;Some even found&#x27;)</span><br><span class="line">else:</span><br><span class="line">  print(&#x27;No even found&#x27;)</span><br></pre></td></tr></table></figure>

<p>The above will have the following result:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">processing 1</span><br><span class="line">processing 2</span><br><span class="line">Some even found</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.mycompiler.io/view/3h1UhlQ">MyCompiler</a></p>
<p>As we can see <code>any</code> build in function iterates a given iterable until any truthy value is found and returns <code>true</code>(otherwise it returns <code>false</code>). The only case that our iterable would have all its elements transformed is if no even value was included in it. In our case the second element was even, so we skipped <code>10^24-2</code> transformations.</p>
<h2 id="How-about-Javascript"><a href="#How-about-Javascript" class="headerlink" title="How about Javascript?"></a>How about Javascript?</h2><p>In javascript the build in method for mapping is the one of <code>Array.prototype.map</code>. This method is on array prototype (applicable to just arrays) and returns a new array. Since an array is returned transformations get executed all at once. How about lodash helpers? Same goes with lodash supporting just arrays. As a result it’s obvious that if we want to get something similar to python we need to implement our own functions that can work lazily using generators.</p>
<h2 id="The-map-function"><a href="#The-map-function" class="headerlink" title="The map function"></a>The map function</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function* map&lt;a, b&gt;(a: Iterable&lt;a&gt;, f:(a:a) =&gt; b)&#123;</span><br><span class="line">  for (const value of a) &#123;</span><br><span class="line">    yield f(value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="The-some-function-similar-to-any-in-python"><a href="#The-some-function-similar-to-any-in-python" class="headerlink" title="The some function (similar to any in python)"></a>The <code>some</code> function (similar to <code>any</code> in python)</h2><p>As with map function we don’t have a build in or lodash function that accepts arbitrary iterables so we resort to the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function some&lt;a&gt;(iterable:Iterable&lt;a&gt;) &#123;</span><br><span class="line">  for (const el of iterable)&#123;</span><br><span class="line">    if (el)) &#123;</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="The-range"><a href="#The-range" class="headerlink" title="The range"></a>The <code>range</code></h2><p>Since 10^24 size array is huge and we <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/length">won’t be able to actually have such an array</a> (it’s bigger than <code>2^32</code>), we ‘ll go ahead and make a generator just for demo purposes:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function* range(start:number, end:number,step: number= 1) &#123;</span><br><span class="line">  let x = start - step;</span><br><span class="line">  while(x &lt; end - step) yield x += step;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h2><p>After putting the above together we achieve the same results as with python build in functions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function isEven(a:number)&#123;</span><br><span class="line">  console.log(`processing $&#123;a&#125;`)</span><br><span class="line">  return a%2 === 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const hugeRange = range(1, Math.pow(10,24)+1);</span><br><span class="line"></span><br><span class="line">if (some(map(hugeRange, isEven)))&#123;</span><br><span class="line">  console.log(&#x27;Some even found&#x27;)</span><br><span class="line">&#125;else&#123;</span><br><span class="line">  console.log(&#x27;No even found&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above will have the following result:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">processing 1</span><br><span class="line">processing 2</span><br><span class="line">Some even found</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/play#code/GYVwdgxgLglg9mAVAAgLYEMAOAedAaZAIwD4AKdALmQEkoBTAJ3UIBs7diDgLyL0BKZAF5iRfgG8AUMmTA4DZKQgIAzlGQA3dCxB1kcYMgHIpMmQE8YdFgBNZpLTrr9pyAL6SPoSLATIVcKjs6GQw9EysdBS0jMxsHIKmyGzqMGA2dAAewsgAtACMkq5yCkqq6tb6hmGxkRKuMmkZmQDULQDcDcgwhqTW-IldMgx0UCAMYMhQDLpdHjIeriNjE7LaKnSeRd7Q8EjITGAA5nSkaugMUBRgIKiEjAR06de39wx4anSYVDd3jELIfKDGQpZDZAHnS55fz0TCdGQAdwAFjA2KRsthkE87LkYV9BJZrHZsi0IbDOosdr5JjAVABRDRPXi-N71GTKMABNgAOhYcCOpAABpgGHAIHQVCo0kdkAAScToNyClzDUbjSboACkACZhEIAQAGLaSDlqZBIkAnABK6GOegBhxOpHyBAAsugoEjuZg4AjnQa8NqACz8FpAzqSHqKAJBUgYTCkC3W20nAi0hlPAZs5CmuA8vkCgDkAGVAno6IzJnJwDZCy43NYNklc-n+aRCwA5OBYyuyOA1uvGoA">Playground Link</a></p>
<h1 id="How-about-existing-javascript-libraries"><a href="#How-about-existing-javascript-libraries" class="headerlink" title="How about existing javascript libraries?"></a>How about existing javascript libraries?</h1><p>The only javascript library that I know of, giving similar behavior is <code>rxjs</code> , through it’s <code>map</code> and <code>every</code> (similar to python’s <code>all</code>) operators. Here is an example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import &#123; range &#125; from &#x27;rxjs/observable/range&#x27;;</span><br><span class="line">import &#123; every, map &#125; from &#x27;rxjs/operators&#x27;;</span><br><span class="line"></span><br><span class="line">function isOdd(a: number) &#123;</span><br><span class="line">  console.log(`processing $&#123;a&#125;`);</span><br><span class="line">  return a % 2 === 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">range(1, Math.pow(10, 24) + 1)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(isOdd),</span><br><span class="line">    every((x) =&gt; x)</span><br><span class="line">  )</span><br><span class="line">  .subscribe((allOdd) =&gt; &#123;</span><br><span class="line">    if (!allOdd) &#123;</span><br><span class="line">      console.log(&#x27;Some even found&#x27;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      console.log(&#x27;All Odd&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>The above will have the following result:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">processing 1</span><br><span class="line">processing 2</span><br><span class="line">Some even found</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://stackblitz.com/edit/typescript-rx-playground-shdnx7">Stackblitz</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/generator/" rel="tag">generator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/iterable/" rel="tag">iterable</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/javascript/" rel="tag">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/typescript/" rel="tag">typescript</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-tips-on-dockerising-python-apps"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/blog/2020/12/23/tips-on-dockerising-python-apps/"
    >Tips on dockerizing python apps</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/blog/2020/12/23/tips-on-dockerising-python-apps/" class="article-date">
  <time datetime="2020-12-23T19:55:30.000Z" itemprop="datePublished">2020-12-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/DevOps/">DevOps</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>While I have been dockerizing a variety of apps I realized that python has its own special set of gotchas. Therefore I decided to write this post to list a few tips that will save time to first-timers.</p>
<h2 id="PYTHONBUFFERRED-Missing-standard-output"><a href="#PYTHONBUFFERRED-Missing-standard-output" class="headerlink" title="PYTHONBUFFERRED: Missing standard output"></a>PYTHONBUFFERRED: Missing standard output</h2><p>One of the first gotchas you might notice is that if you are missing <code>PYTHONBUFFERED</code> configuration stdout/stderr messages may not be preset in terminal output in a timely manner or several lines may be entirely missing on application crash. Depending on you use-case, you may set  PYTHONBUFFERED to a non-empty string so that output will be unbuffered. The above issues are solved afterwards.</p>
<h2 id="Slow-builds-The-curse-of-alpine"><a href="#Slow-builds-The-curse-of-alpine" class="headerlink" title="Slow builds: The curse of alpine"></a>Slow builds: The curse of alpine</h2><p>If you try to build your app in alpine you ‘ll notice slow builds, by magnitude slower than installing apps on your local machine. This is because Standard PyPI wheels don’t work on Alpine. </p>
<p>Most Linux distributions use the GNU version (glibc) of the standard C library that is required by pretty much every C program, including Python. I contrast Alpine Linux uses musl and  since pipy wheels are compiled using giblic they are not supported on Alpine.</p>
<p>Although most Python packages include binary wheels that significantly decrease install time on all alpine set-ups you ‘ll need need to compile all the C code in every Python package that you use.</p>
<p>To my experience the most convenient distro base image for python  is <code>debian slim</code>. I t keeps your image small whilst not sacrificing on distributed wheel support, hence giving faster build times. </p>
<h2 id="Optimal-pipenv-dependency-setup"><a href="#Optimal-pipenv-dependency-setup" class="headerlink" title="Optimal pipenv dependency setup"></a>Optimal pipenv dependency setup</h2><p>In first instance, using pipenv virtual environment seemed quite unstable. Issues ranged form not setting current directory in python path - to crashing shells. I am sure all the above might have already been fixed, and I already knew a few workarounds that could mitigate them. Another thing to consider is optimal image size, global setup of dependencies in an isolated image would hardly cause any issue whilst it can keep image size to the minimum. In order to install to the parent system rather than creating a virtual environment, the <code>--system</code> flag needs to be used. Another thing  we need to take care of is to ensure lock file entries are exactly what’s installed using <code>--ignore-pipfile</code>. To ensure lock file is up-to date we can use <code>--deploy</code> which will fail the command if any dependency is outdated.</p>
<p>Considering the above the ideal command for most use cases I dealt with is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv install --system --deploy --ignore-pipfile</span><br></pre></td></tr></table></figure>

<p>I am sure this is just a few of the things I could list here but I ll keep this page updated.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/docker/" rel="tag">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2012-2022
        <i class="ri-heart-fill heart_icon"></i> Andreas Galazis
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/blog/"><img src="/blog/images/ayer-side.svg" alt="A point in Time"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/blog/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/blog/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/blog/categories">Categories</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/blog/tags">Tags</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="https://www.csmonk.com">About</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/blog/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/blog/js/jquery-3.6.0.min.js"></script>
 
<script src="/blog/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/blog/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->
 
<script src="/blog/js/clickBoom2.js"></script>
 
<!-- CodeCopy -->
 
<link rel="stylesheet" href="/blog/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>